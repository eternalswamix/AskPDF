{% extends "base.html" %}
{% block title %}Chat â€¢ AskPDF Assistant{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto py-6 lg:py-8 px-4 h-[calc(100vh-64px)] overflow-hidden">

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full reveal">

    <!-- SIDEBAR: PDF LIST -->
    <aside class="lg:col-span-3 bg-dark-800 rounded-xl border border-dark-700 flex flex-col overflow-hidden max-h-full">

      <div class="p-4 border-b border-dark-700 flex items-center justify-between shrink-0">
        <div>
          <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-0.5">Your Vault</h4>
          <h3 class="text-lg font-bold text-gray-100">PDF Library</h3>
        </div>
        <a href="{{ url_for('pdf.upload_pdf') }}"
          class="w-8 h-8 rounded-lg bg-primary/20 text-primary flex items-center justify-center hover:bg-primary hover:text-white transition-all shadow-sm">
          <span class="material-symbols-outlined text-lg">add</span>
        </a>
      </div>

      <div class="p-3 bg-dark-900/50 shrink-0">
        <div class="relative group">
          <span
            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-primary text-sm">search</span>
          <input id="pdfSearch" placeholder="Search my docs..."
            class="w-full pl-9 pr-4 py-2 rounded-lg bg-dark-900 border border-dark-700 text-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all placeholder:text-gray-600" />
        </div>
      </div>

      <div id="pdfList" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar">
        {% if pdfs|length == 0 %}
        <div class="text-center py-8 px-4">
          <div
            class="w-12 h-12 bg-dark-700/50 border border-dashed border-dark-700 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-500">
            <span class="material-symbols-outlined text-2xl">inbox</span>
          </div>
          <p class="text-[10px] font-bold text-gray-600 uppercase tracking-widest leading-relaxed">Empty Vault</p>
        </div>
        {% endif %}

        {% for pdf in pdfs %}
        <a href="{{ url_for('chat.chat', pdf_id=pdf.id) }}" class="group block p-3 rounded-xl transition-all border border-transparent hover:bg-dark-700/50
                    {% if pdf.id == pdf_id %} bg-dark-700/50 border-dark-600 shadow-sm {% endif %}">
          <div class="flex items-start gap-3">
            <div
              class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary shrink-0 group-hover:bg-primary group-hover:text-white transition-all">
              <span class="material-symbols-outlined text-lg">description</span>
            </div>
            <div class="min-w-0 flex-1">
              <p class="text-sm font-bold text-gray-200 truncate pdf-name">
                {{ pdf.original_filename if pdf.original_filename else pdf.filename }}
              </p>
              <div class="flex items-center gap-2 mt-1">
                <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">PDF</span>
                <span class="w-1 h-1 rounded-full bg-gray-600"></span>
                <span class="text-[10px] font-bold text-green-500 uppercase tracking-wider">Indexed</span>
              </div>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
    </aside>

    <!-- CHAT AREA -->
    <section
      class="lg:col-span-9 bg-dark-800 rounded-xl border border-dark-700 flex flex-col overflow-hidden relative h-full">

      <!-- Chat Header -->
      <div
        class="p-4 border-b border-dark-700 bg-dark-800 sticky top-0 z-20 flex items-center justify-between shrink-0">
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 rounded-xl bg-primary flex items-center justify-center text-white shadow-lg shadow-purple-900/20">
            <span class="material-symbols-outlined">smart_toy</span>
          </div>
          <div>
            <h2 class="text-base font-bold text-gray-100">Intelligence Assistant</h2>
            <div class="flex items-center gap-2">
              <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
              <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Active Insight Mode</span>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button
            class="w-9 h-9 rounded-lg border border-dark-700 flex items-center justify-center text-gray-500 hover:bg-dark-700 transition-colors">
            <span class="material-symbols-outlined text-lg">settings</span>
          </button>
        </div>
      </div>

      <!-- Messages Container -->
      <div id="chatBox" class="flex-1 overflow-y-auto p-6 space-y-6 bg-dark-900/30 custom-scrollbar">

        {% if messages|length == 0 %}
        <div class="h-full flex flex-col items-center justify-center text-center opacity-60 py-10">
          <div
            class="w-16 h-16 bg-dark-800 rounded-2xl shadow-soft flex items-center justify-center text-primary mb-6 border border-dark-700">
            <span class="material-symbols-outlined text-3xl">auto_awesome</span>
          </div>
          <h3 class="text-xl font-bold text-gray-200 mb-3">Start your inquiry</h3>
          <p class="text-gray-500 max-w-sm font-medium text-sm leading-relaxed">
            Ask anything. I am strictly grounded in the document context for high-fidelity responses.
          </p>
          <div class="mt-6 flex gap-3">
            <span
              class="px-3 py-1.5 rounded-lg bg-dark-800 border border-dark-700 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Type
              "Summary"</span>
            <span
              class="px-3 py-1.5 rounded-lg bg-dark-800 border border-dark-700 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Ask
              for citations</span>
          </div>
        </div>
        {% endif %}

        {% for msg in messages %}
        <!-- User Message -->
        <div class="flex justify-end gap-3 reveal slide-up">
          <div class="max-w-[85%] lg:max-w-[75%]">
            <div class="bg-primary text-white rounded-2xl rounded-tr-none px-5 py-3 shadow-md">
              <p class="text-sm font-medium leading-relaxed whitespace-pre-line">{{ msg.q }}</p>
            </div>
            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mt-1.5 px-1 text-right italic">
              You</p>
          </div>
          <div
            class="w-8 h-8 rounded-full bg-dark-700 flex items-center justify-center text-gray-400 shrink-0 mt-1 text-xs font-bold">
            ME</div>
        </div>

        <!-- AI Message -->
        <div class="flex justify-start gap-3 reveal slide-up">
          <div
            class="w-8 h-8 rounded-xl bg-dark-700 border border-dark-600 flex items-center justify-center text-primary shrink-0 mt-1">
            <span class="material-symbols-outlined text-sm">robot_2</span>
          </div>
          <div class="max-w-[90%] lg:max-w-[80%]">
            <div
              class="bg-dark-800 border border-dark-700 text-gray-200 rounded-2xl rounded-tl-none px-5 py-4 shadow-sm leading-relaxed text-sm">
              <!-- Using raw output for markdown if possible, otherwise pre-line -->
              <div class="prose prose-invert prose-sm max-w-none">
                {{ msg.a | safe }}
              </div>
            </div>
            <div class="flex items-center gap-3 mt-2 px-1">
              <span class="text-[10px] font-bold text-primary uppercase tracking-widest italic flex items-center gap-1">
                <span class="w-1.5 h-1.5 rounded-full bg-primary"></span> Verified
              </span>
            </div>
          </div>
        </div>
        {% endfor %}

        <!-- Typing Indicator -->
        <div id="typing" class="hidden flex justify-start gap-4">
          <div
            class="w-8 h-8 rounded-xl bg-dark-700 border border-dark-600 flex items-center justify-center text-gray-500 shrink-0 mt-1">
            <span class="material-symbols-outlined text-sm">psychology</span>
          </div>
          <div class="bg-dark-800 border border-dark-700 rounded-2xl rounded-tl-none px-4 py-3 flex items-center gap-3">
            <div class="flex gap-1.5">
              <div class="w-1.5 h-1.5 rounded-full bg-gray-500 animate-bounce"></div>
              <div class="w-1.5 h-1.5 rounded-full bg-gray-500 animate-bounce" style="animation-delay: 0.1s"></div>
              <div class="w-1.5 h-1.5 rounded-full bg-gray-500 animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="p-4 lg:p-6 border-t border-dark-700 bg-dark-800 sticky bottom-0 z-20 shrink-0">
        <form id="chatForm" method="POST" class="relative group">
          <input name="question" id="questionInput" placeholder="Ask a technical question..." required
            autocomplete="off"
            class="w-full pl-5 pr-32 py-4 rounded-xl bg-dark-900 border border-dark-700 font-medium text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all placeholder:text-gray-600" />

          <button id="sendBtn" type="submit"
            class="absolute right-2 top-2 bottom-2 bg-primary hover:bg-primary-hover text-white px-6 rounded-lg font-bold text-sm transition-all flex items-center justify-center gap-2 active:scale-95 shadow-lg shadow-purple-900/20">
            <span id="sendText" class="hidden sm:inline">Send</span>
            <span class="material-symbols-outlined text-sm">send</span>
          </button>
        </form>
        <div class="flex items-center justify-between mt-3 px-2">
          <p class="text-[10px] font-bold text-gray-600 uppercase tracking-widest">Strict Context</p>
          <p class="text-[10px] font-bold text-gray-600 uppercase tracking-widest italic">Gemini Pro</p>
        </div>
      </div>
    </section>

  </div>
</div>

<script>
  const chatBox = document.getElementById("chatBox");
  chatBox.scrollTop = chatBox.scrollHeight;

  const chatForm = document.getElementById("chatForm");
  const typing = document.getElementById("typing");
  const sendBtn = document.getElementById("sendBtn");
  const questionInput = document.getElementById("questionInput");

  chatForm.addEventListener("submit", (e) => {
    typing.classList.remove("hidden");
    sendBtn.disabled = true;
    sendBtn.classList.add("opacity-50", "cursor-not-allowed");
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  const pdfSearch = document.getElementById("pdfSearch");
  const pdfList = document.getElementById("pdfList");

  pdfSearch.addEventListener("input", () => {
    const value = pdfSearch.value.toLowerCase();
    const items = pdfList.querySelectorAll("a");
    items.forEach((item) => {
      const nameEl = item.querySelector(".pdf-name");
      const name = nameEl ? nameEl.innerText.toLowerCase() : "";
      item.style.display = name.includes(value) ? "block" : "none";
    });
  });
</script>

{% endblock %}