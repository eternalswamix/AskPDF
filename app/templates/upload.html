{% extends "base.html" %}
{% block title %}Upload Document • AskPDF{% endblock %}

{% block content %}
<section class="max-w-4xl mx-auto py-12 px-6">

  <div class="flex flex-col md:flex-row items-center justify-between gap-8 mb-12 reveal">
    <div>
      <h1 class="text-3xl font-bold text-gray-100 leading-tight">Add more <span
          class="text-primary">Intelligence</span>.</h1>
      <p class="text-gray-400 mt-2 font-medium">
        Upload a new PDF to index it into your private vector database.
      </p>
    </div>

    <a href="{{ url_for('main.index') }}"
      class="inline-flex items-center gap-2 bg-dark-800 border border-dark-700 hover:border-gray-500 px-5 py-2.5 rounded-xl text-gray-300 font-medium transition shadow-soft">
      <span class="material-symbols-outlined text-sm">home</span>
      Return Home
    </a>
  </div>

  <div class="bg-dark-800 rounded-2xl shadow-soft border border-dark-700 p-8 lg:p-12 reveal delay-100">

    {% if error %}
    <div
      class="mb-8 flex items-center gap-3 p-4 rounded-lg bg-red-900/20 border border-red-900/50 text-red-200 text-sm animate-shake">
      <span class="material-symbols-outlined text-red-400">error</span>
      {{ error }}
    </div>
    {% endif %}

    <form id="uploadForm" method="POST" enctype="multipart/form-data" class="space-y-8">

      <!-- DRAG AND DROP AREA -->
      <div id="dropZone"
        class="group relative border-2 border-dashed border-dark-700 rounded-xl bg-dark-900/50 p-12 text-center transition-all hover:border-primary/50 hover:bg-dark-900 cursor-pointer">

        <div class="relative z-10">
          <div
            class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center text-primary mx-auto mb-6 group-hover:scale-110 transition-transform">
            <span class="material-symbols-outlined text-3xl">cloud_upload</span>
          </div>
          <h3 class="text-xl font-bold text-gray-100 mb-2">Drag & Drop PDF</h3>
          <p class="text-gray-500 font-medium text-sm">Max file size: 20MB. Only PDF files supported.</p>

          <div class="mt-8">
            <label
              class="bg-primary hover:bg-primary-hover text-white px-6 py-3 rounded-xl font-bold text-sm cursor-pointer shadow-lg shadow-purple-900/20 transition-all active:scale-95 inline-block">
              Select File
              <input type="file" id="pdfInput" name="pdf" accept="application/pdf" required class="hidden" />
            </label>
          </div>
        </div>

        <div id="fileNameBox"
          class="hidden mt-6 inline-flex items-center gap-2 px-4 py-2 bg-green-900/20 text-green-400 rounded-lg border border-green-900/30 font-bold text-xs uppercase tracking-wider">
          <span class="material-symbols-outlined text-sm">check_circle</span>
          <span id="fileName">No file selected</span>
        </div>
      </div>

      <!-- API KEY INPUT -->
      <div class="bg-dark-900/50 border border-dark-700 rounded-xl p-6">
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 px-1">Gemini API Key
          (Required)</label>
        <div class="relative group">
          <span
            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-primary group-focus-within:text-white transition-colors">vpn_key</span>
          <input name="gemini_api_key" type="password" placeholder="Paste your Google Gemini API Key here..."
            value="{{ user.gemini_api_key if user.gemini_api_key else '' }}" required
            class="w-full pl-11 pr-4 py-3 rounded-xl bg-dark-900 border border-dark-700 text-gray-200 placeholder:text-gray-600 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all font-mono text-sm shadow-inner" />
        </div>
        <p class="text-[10px] text-gray-500 mt-2 px-1 font-medium">
          We need your API key to process the PDF. It will be saved securely for future use.
        </p>
      </div>

      <button id="uploadBtn" type="submit"
        class="w-full bg-primary hover:bg-primary-hover text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-purple-900/20 transition-all flex items-center justify-center gap-3 active:scale-[0.98]">
        Process & Index PDF
        <span class="material-symbols-outlined">analytics</span>
      </button>

      <!-- LOADING STATE -->
      <div id="loadingBox" class="hidden bg-dark-900/50 backdrop-blur rounded-xl p-8 mt-4 border border-dark-700">
        <div class="flex flex-col md:flex-row items-center gap-6">
          <div class="relative">
            <div class="w-12 h-12 rounded-full border-4 border-dark-700 border-t-primary animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
              <span class="material-symbols-outlined text-primary text-lg animate-pulse">psychology</span>
            </div>
          </div>

          <div class="flex-1 w-full text-center md:text-left">
            <p id="loadingText" class="text-gray-200 font-bold text-lg mb-1 italic">
              Scanning your PDF…
            </p>
            <p class="text-xs text-gray-500 font-medium tracking-wide">
              Please don’t exit. We are creating semantic embeddings.
            </p>

            <div class="mt-4 h-2 w-full rounded-full bg-dark-700 overflow-hidden relative">
              <div id="fakeBar" class="h-full w-[15%] bg-primary rounded-full transition-all duration-700 ease-out">
              </div>
            </div>
          </div>
        </div>
      </div>

    </form>
  </div>

  <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6 reveal delay-200">
    <div class="flex items-center gap-3 text-gray-500">
      <span class="material-symbols-outlined text-dark-700">encrypted</span>
      <span class="text-xs font-bold uppercase tracking-widest">Encrypted</span>
    </div>
    <div class="flex items-center gap-3 text-gray-500">
      <span class="material-symbols-outlined text-dark-700">offline_bolt</span>
      <span class="text-xs font-bold uppercase tracking-widest">Fast indexing</span>
    </div>
    <div class="flex items-center gap-3 text-gray-500">
      <span class="material-symbols-outlined text-dark-700">token</span>
      <span class="text-xs font-bold uppercase tracking-widest">Vector Search</span>
    </div>
  </div>

</section>

<script>
  const form = document.getElementById("uploadForm");
  const btn = document.getElementById("uploadBtn");
  const input = document.getElementById("pdfInput");
  const fileNameBox = document.getElementById("fileNameBox");
  const fileName = document.getElementById("fileName");
  const loadingBox = document.getElementById("loadingBox");
  const loadingText = document.getElementById("loadingText");
  const fakeBar = document.getElementById("fakeBar");

  input.addEventListener("change", (e) => {
    if (input.files.length > 0) {
      fileName.textContent = input.files[0].name;
      fileNameBox.classList.remove("hidden");
    }
  });

  const steps = [
    "Reading PDF bytes...",
    "Splitting into semantic chunks...",
    "Generating vector embeddings...",
    "Indexing in your private storage...",
    "Almost ready for chat..."
  ];

  form.addEventListener("submit", (e) => {
    btn.classList.add("hidden");
    loadingBox.classList.remove("hidden");

    let i = 0;
    setInterval(() => {
      i = (i + 1) % steps.length;
      loadingText.innerText = steps[i];
    }, 1800);

    let percent = 15;
    setInterval(() => {
      percent += Math.floor(Math.random() * 10) + 5;
      if (percent >= 98) percent = 98;
      fakeBar.style.width = percent + "%";
    }, 1200);
  });
</script>

{% endblock %}